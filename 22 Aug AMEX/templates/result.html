
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Results — NACV & Gross Incentive</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  </head>
  <body>
    <div class="container">
      <h1>Results</h1>

      <section>
        <h2>Extracted Tier Rules (from contract)</h2>
        {% if tiers %}
          <ul class="tiers">
            {% for t in tiers %}<li>{{ t }}</li>{% endfor %}
          </ul>
        {% else %}
          <p class="warn">No tiers found in the contract file.</p>
        {% endif %}
      </section>

      <section class="grid two">
        <div class="card">
          <h3>NACV</h3>
          <p class="big">{{ format_currency(nacv_value) }}</p>
          <ul class="muted">
            <li>{{ bus_col }}: <strong>{{ format_currency(total_bus) }}</strong></li>
            <li>Total losses ({{ ar_col }} + {{ wr_col }}): <strong>{{ format_currency(total_losses) }}</strong></li>
            {% if month_col and chosen_months %}
              <li>Months filtered (by {{ month_col }}): {{ chosen_months }}</li>
            {% elif data_format == "horizontal" %}
              <li>Data format: Monthly data summed across all periods</li>
            {% endif %}
            {% if data_format == "horizontal" %}
              <li><strong>Note:</strong> Totals have been written back to the Excel file</li>
            {% endif %}
          </ul>
        </div>
        <div class="card">
          <h3>Gross Incentive</h3>
          <p class="big">{{ format_currency(gross_value) }}</p>
          
          {% if breakdown.explanation %}
          <div style="margin: 16px 0;">
            <p class="help">{{ breakdown.explanation }}</p>
          </div>
          {% endif %}
          
          {% if breakdown.calculation_steps %}
          <div style="margin: 16px 0;">
            <h4 style="margin-bottom: 8px; color: var(--muted);">Calculation Steps:</h4>
            <ul style="list-style: none; padding-left: 0;">
              {% for step in breakdown.calculation_steps %}
                <li style="padding: 6px 12px; background: #0f1426; border: 1px solid #1e2741; border-radius: 8px; margin-bottom: 4px; font-family: monospace;">{{ step }}</li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
          
          <details style="margin-top: 16px;">
            <summary style="cursor: pointer; color: var(--muted);">Technical Details</summary>
            <pre style="margin-top: 8px;">{{ breakdown | tojson(indent=2) }}</pre>
          </details>
        </div>
      </section>

      {% if chd_rules and (chd_rules.threshold_days is not none or chd_rules.adjustment_bps_per_day is not none) %}
      <section>
        <h2>CHD (Client Held Days) Rules</h2>
        <div class="card">
          {% if chd_rules.threshold_days and chd_rules.adjustment_bps_per_day %}
            <p><strong>Rule:</strong> If CHD Performance ≥ {{ chd_rules.threshold_days }} days, then {{ chd_rules.adjustment_bps_per_day }} bps per day is deducted from Gross Incentive</p>
          {% endif %}
          {% if chd_rules.description %}
            <details>
              <summary>Contract Details</summary>
              <p class="help">{{ chd_rules.description }}</p>
            </details>
          {% endif %}
        </div>
      </section>
      {% endif %}

      {% if chd_breakdown.applied %}
      <section>
        <h2>CHD Adjustment Applied</h2>
        <div class="card">
          <p><strong>CHD Performance:</strong> {{ chd_breakdown.chd_performance_days }} days</p>
          <p><strong>Adjustment:</strong> {{ chd_breakdown.total_adjustment_bps }} bps ({{ chd_breakdown.chd_performance_days }} days × {{ chd_breakdown.adjustment_bps_per_day }} bps/day)</p>
          {% if chd_breakdown.adjustment_type == "add" %}
            <p><strong>CHD Bonus:</strong> <span class="ok">+{{ format_currency(chd_adjustment) }}</span></p>
          {% else %}
            <p><strong>CHD Deduction:</strong> <span class="warn">-{{ format_currency(chd_adjustment) }}</span></p>
          {% endif %}
        </div>
      </section>

      <section>
        <h2>Net Incentive (After CHD Adjustment)</h2>
        <div class="card">
          <p class="big">{{ format_currency(net_incentive) }}</p>
          <ul class="muted">
            <li>Gross Incentive: {{ format_currency(gross_value) }}</li>
            {% if chd_breakdown.adjustment_type == "add" %}
              <li>CHD Adjustment: +{{ format_currency(chd_adjustment) }}</li>
            {% else %}
              <li>CHD Adjustment: -{{ format_currency(chd_adjustment) }}</li>
            {% endif %}
            <li><strong>Net Incentive: {{ format_currency(net_incentive) }}</strong></li>
          </ul>
        </div>
      </section>
      {% elif chd_breakdown.reason %}
      <section>
        <h2>CHD Status</h2>
        <div class="card">
          <p class="help">{{ chd_breakdown.reason }}</p>
          <p><strong>Net Incentive:</strong> {{ format_currency(gross_value) }} (no CHD adjustment applied)</p>
        </div>
      </section>
      {% endif %}

      <p><a href="{{ url_for('index') }}">&larr; Back</a></p>
    </div>
  </body>
</html>
